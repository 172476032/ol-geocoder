(function(win,doc){"use strict";this.Geocoder=function(){var Geocoder=function(control_type,opt_options){var nominatim=new Geocoder.Nominatim(this,opt_options);this.layer=nominatim.layer,ol.control.Control.call(this,{element:nominatim.els.container}),this.set("geocoder","")};return ol.inherits(Geocoder,ol.control.Control),Geocoder.prototype.getSource=function(){return this.layer.getSource()},function(Geocoder){Geocoder.Nominatim=function(geocoder,opt_options){this.geocoder=geocoder,this.feature_increment=0,this.layer_name="geocoder-nominatim-"+(new Date).getTime().toString(36),this.layer=new ol.layer.Vector({name:this.layer_name,source:new ol.source.Vector});var defaults={provider:"mapquest",keepOpen:!1};this.options=utils.mergeOptions(defaults,opt_options),this.constants={class_container:"ol-geocoder",expanded_class:"ol-geocoder-search-expanded",road:"ol-geocoder-road",city:"ol-geocoder-city",country:"ol-geocoder-country"};this.createControl();return this.els=Geocoder.Nominatim.elements,this.setListeners(),this},Geocoder.Nominatim.prototype={createControl:function(){var container=utils.createElement(["div",{classname:this.constants.class_container}],Geocoder.Nominatim.html);return Geocoder.Nominatim.elements={container:container,control:container.querySelector(".ol-geocoder-search"),btn_search:container.querySelector(".ol-geocoder-btn-search"),input_search:container.querySelector(".ol-geocoder-input-search"),result_container:container.querySelector(".ol-geocoder-result")},container},setListeners:function(){var this_=this,openSearch=function(){utils.hasClass(this_.els.control,this_.constants.expanded_class)?this_.collapse():this_.expand()},query=function(evt){if(13==evt.keyCode){var q=utils.htmlEscape(this_.els.input_search.value);this_.query(q)}};this_.els.input_search.addEventListener("keydown",query,!1),this_.els.btn_search.addEventListener("click",openSearch,!1)},expand:function(){utils.removeClass(this.els.input_search,"ol-geocoder-loading"),utils.addClass(this.els.control,this.constants.expanded_class);var input=this.els.input_search;window.setTimeout(function(){input.focus()},100)},collapse:function(){this.els.input_search.value="",this.els.input_search.blur(),utils.removeClass(this.els.control,this.constants.expanded_class),this.clearResults()},clearResults:function(collapse){collapse?this.collapse():utils.removeAllChildren(this.els.result_container)},query:function(query){var this_=this,input=this.els.input_search,provider=this.getProvider(this.options.provider,query,this.options.lang,this.options.limit);this.clearResults(),utils.addClass(input,"ol-geocoder-loading"),utils.json(provider.url,provider.params).when({ready:function(){utils.removeClass(input,"ol-geocoder-loading");var response;switch(this_.options.provider){case"osm":case"mapquest":response=this.response.length>0?this.response:void 0;break;case"photon":response=this.response.features.length>0?this_.photonResponse(this.response.features):void 0}if(response){this_.createList(response);var canvas=this_.geocoder.getMap().getTargetElement();canvas.addEventListener("click",{handleEvent:function(evt){this_.clearResults(!0),canvas.removeEventListener(evt.type,this,!1)}},!1)}},error:function(){utils.removeClass(input,"ol-geocoder-loading");var li=utils.createElement("li","<h5>Error! No internet connection?</h5>");this_.els.result_container.appendChild(li)}})},createList:function(response){var this_=this,ul=this.els.result_container;response.forEach(function(row){var address=this_.addressTemplate(row),html='<a href="#">'+address+"</a>",li=utils.createElement("li",html);li.addEventListener("click",function(evt){evt.preventDefault(),this_.chosen(row,address)},!1),ul.appendChild(li)})},addressTemplate:function(row){var r=row.address,html=[];return r.name&&html.push('<span class="'+this.constants.road+'">{name}</span>'),(r.road||r.building)&&html.push('<span class="'+this.constants.road+'">{building} {road} {house_number}</span>'),(r.city||r.town||r.village)&&html.push('<span class="'+this.constants.city+'">{postcode} {city} {town} {village}</span>'),(r.state||r.country)&&html.push('<span class="'+this.constants.country+'">{state} {country}</span>'),utils.template(html.join("<br/>"),r)},chosen:function(place,address){this.options.keepOpen===!1&&this.clearResults(!0);var map=this.geocoder.getMap(),coord=utils.to3857([place.lon,place.lat]),resolution=2.388657133911758,duration=500,obj={coord:coord,address:address},pan=ol.animation.pan({duration:duration,source:map.getView().getCenter()}),zoom=ol.animation.zoom({duration:duration,resolution:map.getView().getResolution()});map.beforeRender(pan,zoom),map.getView().setCenter(coord),map.getView().setResolution(resolution),this.createFeature(obj)},createFeature:function(obj){var feature=new ol.Feature({address:obj.address,geometry:new ol.geom.Point(obj.coord)}),feature_id=this.featureId(),feature_style=this.options.featureStyle||Geocoder.Nominatim.featureStyle;this.addLayer(),feature.setStyle(feature_style),feature.setId(feature_id),this.getSource().addFeature(feature),this.geocoder.set("geocoder",feature_id)},featureId:function(){return"geocoder-"+ ++this.feature_increment},photonResponse:function(features){var array=features.map(function(feature){var obj={lon:feature.geometry.coordinates[0],lat:feature.geometry.coordinates[1],address:{name:feature.properties.name,city:feature.properties.city,state:feature.properties.state,country:feature.properties.country}};return obj});return array},getSource:function(){return this.layer.getSource()},addLayer:function(){var found,this_=this,map=this.geocoder.getMap();map.getLayers().forEach(function(layer){found=layer===this_.layer?!0:!1}),found===!1&&map.addLayer(this.layer)},getProvider:function(key,query,lang,limit){var provider=Geocoder.Nominatim.providers[key];if(provider.params.q=query,provider.params.limit=limit||provider.params.limit,"photon"==key){lang=lang.toLowerCase();var accepted=["de","it","fr","en"];accepted.indexOf(lang)>-1?provider.params.lang=lang:provider.params.lang}else provider.params["accept-language"]=lang||provider.params["accept-language"];return provider}},Geocoder.Nominatim.elements={},Geocoder.Nominatim.providers={osm:{url:"http://nominatim.openstreetmap.org/search/",params:{format:"json",q:"",addressdetails:1,limit:10,"accept-language":"en-US"}},mapquest:{url:"http://open.mapquestapi.com/nominatim/v1/search.php",params:{format:"json",q:"",addressdetails:1,limit:10,"accept-language":"en-US"}},photon:{url:"http://photon.komoot.de/api/",params:{q:"",limit:10,lang:"en"}}},Geocoder.Nominatim.featureStyle=[new ol.style.Style({image:new ol.style.Icon({scale:.7,anchor:[.5,1],src:"//cdn.rawgit.com/jonataswalker/map-utils/master/images/marker.png"}),zIndex:5}),new ol.style.Style({image:new ol.style.Circle({fill:new ol.style.Fill({color:[235,235,235,1]}),stroke:new ol.style.Stroke({color:[0,0,0,1]}),radius:5}),zIndex:4})],Geocoder.Nominatim.html=['<div class="ol-geocoder-search ol-control">','<button class="ol-geocoder-btn-search"></button>','<input type="text" class="ol-geocoder-input-search">',"</div>",'<ul class="ol-geocoder-result"></ul>'].join("")}(Geocoder),function(win,doc){var getXhr=function(){var xhr=!1;if(win.XMLHttpRequest)xhr=new XMLHttpRequest;else if(win.ActiveXObject)try{xhr=new ActiveXObject("Msxml2.XMLHTTP")}catch(e){try{xhr=new ActiveXObject("Microsoft.XMLHTTP")}catch(e){xhr=!1}}return xhr};Geocoder.Utils={whiteSpaceRegex:/\s+/,json:function(url,data){function onload(){200===xhr.status&&when.ready.call({response:JSON.parse(xhr.response)})}function onerror(){when.error.call({response:"Can't xhr on url: "+url})}function onprogress(){}if(data&&"object"==typeof data){var y="",e=encodeURIComponent;for(var x in data)y+="&"+e(x)+"="+e(data[x]);data=y.slice(1),url+=(/\?/.test(url)?"&":"?")+data}var xhr=getXhr(),when={};return xhr.open("GET",url,!0),xhr.setRequestHeader("Accept","application/json"),xhr.onload=onload,xhr.onerror=onerror,xhr.onprogress=onprogress,xhr.send(null),{when:function(obj){when.ready=obj.ready,when.error=obj.error}}},to3857:function(coord){return ol.proj.transform([parseFloat(coord[0]),parseFloat(coord[1])],"EPSG:4326","EPSG:3857")},to4326:function(coord){return ol.proj.transform([parseFloat(coord[0]),parseFloat(coord[1])],"EPSG:3857","EPSG:4326")},classRegex:function(classname){return new RegExp("(^|\\s+)"+classname+"(\\s+|$)")},_addClass:function(el,c){el.classList?el.classList.add(c):el.className=(el.className+" "+c).trim()},addClass:function(el,classname){if(Array.isArray(el))return void el.forEach(function(each){utils.addClass(each,classname)});for(var array=Array.isArray(classname)?classname:classname.split(utils.whiteSpaceRegex),i=array.length;i--;)utils.hasClass(el,array[i])||utils._addClass(el,array[i])},_removeClass:function(el,c){el.classList?el.classList.remove(c):el.className=el.className.replace(utils.classReg(c)," ").trim()},removeClass:function(el,classname){if(Array.isArray(el))return void el.forEach(function(each){utils.removeClass(each,classname)});for(var array=Array.isArray(classname)?classname:classname.split(utils.whiteSpaceRegex),i=array.length;i--;)utils.hasClass(el,array[i])&&utils._removeClass(el,array[i])},hasClass:function(el,c){return el.classList?el.classList.contains(c):utils.classReg(c).test(el.className)},toggleClass:function(el,c){return Array.isArray(el)?void el.forEach(function(each){utils.toggleClass(each,c)}):void(el.classList?el.classList.toggle(c):utils.hasClass(el,c)?utils._removeClass(el,c):utils._addClass(el,c))},$:function(id){return id="#"===id[0]?id.substr(1,id.length):id,doc.getElementById(id)},isElement:function(obj){return"HTMLElement"in win?!!obj&&obj instanceof HTMLElement:!!obj&&"object"==typeof obj&&1===obj.nodeType&&!!obj.nodeName},getAllChildren:function(node,tag){return[].slice.call(node.getElementsByTagName(tag))},emptyArray:function(array){for(;array.length;)array.pop()},removeAllChildren:function(node){for(;node.firstChild;)node.removeChild(node.firstChild)},removeAll:function(collection){for(var node;node=collection[0];)node.parentNode.removeChild(node)},getChildren:function(node,tag){return[].filter.call(node.childNodes,function(el){return tag?1==el.nodeType&&el.tagName.toLowerCase()==tag:1==el.nodeType})},template:function(html,row){var this_=this;return html.replace(/\{ *([\w_-]+) *\}/g,function(html,key){var value=void 0===row[key]?"":row[key];return this_.htmlEscape(value)})},htmlEscape:function(str){return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")},mergeOptions:function(obj1,obj2){var obj3={};for(var attrname in obj1)obj3[attrname]=obj1[attrname];for(var attrname in obj2)obj3[attrname]=obj2[attrname];return obj3},createElement:function(node,html){var elem;if(Array.isArray(node)){if(elem=doc.createElement(node[0]),node[1].id&&(elem.id=node[1].id),node[1].classname&&(elem.className=node[1].classname),node[1].attr){var attr=node[1].attr;if(Array.isArray(attr))for(var i=-1;++i<attr.length;)elem.setAttribute(attr[i].name,attr[i].value);else elem.setAttribute(attr.name,attr.value)}}else elem=doc.createElement(node);elem.innerHTML=html;for(var frag=doc.createDocumentFragment();elem.childNodes[0];)frag.appendChild(elem.childNodes[0]);return elem.appendChild(frag),elem}}}(win,doc),Geocoder}();var utils=Geocoder.Utils}).call(this,window,document);